# STEP文件加载卡死问题 - 快速修复

## 问题描述
导入STEP文件时程序卡死闪退

## 原因分析
1. **FreeCAD转换阻塞主线程** - 大型STEP文件转换需要很长时间
2. **内存不足** - 复杂模型需要大量内存
3. **转换超时** - 转换过程超过预期时间

## 已实施的修复

### 1. 添加用户选择对话框
- 不再自动转换，避免卡死
- 用户可以选择：自动转换、手动转换、取消
- 明确提示可能的等待时间

### 2. 缩短超时时间
- 从60秒降低到30秒
- 超时后自动终止FreeCAD进程
- 避免长时间无响应

### 3. 优先使用FreeCADCmd
- 命令行版本更稳定
- 无GUI开销
- 更快的启动和执行

### 4. 提供手动转换指导
- 详细的步骤说明
- 多种转换方法
- 在线工具链接

## 推荐使用方法

### 方法1: 手动转换（最稳定）

#### 使用FreeCAD手动转换：
```bash
1. 打开 K:\Kapps\FreeCAD\bin\FreeCAD.exe
2. 文件 → 打开 → 选择STEP文件
3. 等待导入完成（可能需要几分钟）
4. 文件 → 导出 → 选择STL格式
5. 保存到相同目录，文件名保持一致
6. 在程序中导入生成的STL文件
```

#### 使用FreeCADCmd命令行转换：
```bash
# 运行转换脚本
K:\Kapps\FreeCAD\bin\FreeCADCmd.exe test_step_conversion_direct.py
```

### 方法2: 在线转换（最简单）

推荐网站：
- https://www.convertio.co/step-stl/
- https://anyconv.com/step-to-stl-converter/

步骤：
1. 上传STEP文件
2. 选择STL格式
3. 下载转换后的文件
4. 保存到相同目录
5. 在程序中导入STL文件

### 方法3: 程序自动转换（小文件）

仅适用于：
- 文件大小 < 10MB
- 简单几何形状
- 对象数量 < 100

使用步骤：
1. 启动程序
2. 文件 → 导入车间模型
3. 选择STEP文件
4. 在对话框中选择"自动转换"
5. 等待30秒（如果超时会自动终止）

## 测试步骤

### 测试1: 简单STEP文件
```bash
# 创建简单测试文件
K:\Kapps\FreeCAD\bin\FreeCADCmd.exe create_simple_step_test.py

# 在程序中导入 data/model/simple_test.STEP
```

### 测试2: 实际STEP文件
```bash
# 手动转换
1. 打开FreeCAD
2. 导入 data/model/MPX3500.STEP
3. 导出为 data/model/MPX3500.stl
4. 在程序中导入STL文件
```

## 性能优化建议

### 对于大型STEP文件：
1. **降低网格精度**
   - 修改 `linear_deflection = 0.5` （默认0.1）
   - 修改 `angular_deflection = 0.5` （默认0.1）

2. **分批处理**
   - 将大型装配体拆分为多个部件
   - 分别转换和导入

3. **使用更强大的硬件**
   - 16GB+ RAM
   - SSD硬盘
   - 多核CPU

## 故障排除

### 问题: 程序仍然卡死
**解决**: 
- 关闭程序
- 手动转换STEP文件
- 直接导入STL文件

### 问题: FreeCAD转换失败
**解决**:
- 检查STEP文件是否损坏
- 尝试在FreeCAD中打开查看
- 使用在线转换工具

### 问题: STL文件太大
**解决**:
- 增大网格偏差参数
- 简化模型
- 使用网格简化工具

## 当前文件状态

### 杭汽轮总装.STEP
- 大小: 未知
- 复杂度: 高（总装模型）
- 建议: 手动转换

### MPX3500.STEP
- 大小: 未知
- 复杂度: 中等（机械臂）
- 建议: 手动转换或在线转换

## 下一步计划

1. ✅ 添加用户选择对话框
2. ✅ 缩短超时时间
3. ✅ 提供手动转换指导
4. 🔄 考虑实现后台线程转换
5. 🔄 添加转换进度显示
6. 🔄 支持取消转换操作