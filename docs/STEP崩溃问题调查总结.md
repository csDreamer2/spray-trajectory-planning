# STEP导入崩溃问题调查总结

## 🔍 问题描述

**核心问题**: 主程序导入STEP模型后，在模型树构建完成约2秒后发生程序崩溃

**关键对比**: 
- ✅ **独立测试程序** (`step_tree_only_test.exe`) - 完全正常
- ❌ **主程序** (`SprayTrajectoryPlanning.exe`) - 崩溃

## 📊 已排除的假设

### 1. ❌ STEP解析本身的问题
- **证据**: 独立测试程序能完美运行
- **结论**: OpenCASCADE STEP解析功能正常

### 2. ❌ VTK与OpenCASCADE冲突
- **测试**: 完全禁用VTK组件后仍然崩溃
- **结论**: VTK不是崩溃的直接原因

### 3. ❌ 复杂Lambda表达式问题
- **修复**: 改用独立槽函数处理信号
- **结果**: 仍然崩溃

### 4. ❌ 复杂停靠窗口配置
- **测试**: 简化为只有STEP模型树和日志面板
- **结果**: 仍然崩溃

## 🎯 当前线索

### 关键差异分析

| 方面 | 独立测试程序 | 主程序 | 可能影响 |
|------|-------------|--------|----------|
| **父对象** | 无父对象 | `MainWindow(this)` | Qt对象生命周期 |
| **窗口类型** | `QWidget` | `QMainWindow` | 事件循环复杂性 |
| **组件数量** | 单一组件 | 多个UI组件 | 内存管理冲突 |
| **事件循环** | 简单 | 复杂(菜单/工具栏/状态栏) | 事件处理冲突 |

### 崩溃时序
```
1. STEP文件读取 ✅
2. 数据传输 ✅ (已修复阻塞问题)
3. 模型树构建 ✅
4. Qt模型更新 ✅
5. 完成信号发送 ✅
6. 主线程信号处理 ❌ 崩溃点 (约2秒后)
```

## 🧪 已实施的修复

### 1. Transfer阻塞修复 ✅
- **问题**: `reader.Transfer()`调用阻塞
- **解决**: 多重线程状态刷新 + 延迟信号发送
- **效果**: 不再需要Ctrl+C中断

### 2. 异常处理增强 ✅
- **范围**: 所有关键方法添加try-catch保护
- **效果**: 提高程序健壮性，但未解决崩溃

### 3. 信号处理优化 ✅
- **改进**: 使用QTimer延迟处理 + 独立槽函数
- **效果**: 避免复杂lambda，但未解决崩溃

## 🔍 下一步调查方向

### 优先级1: Qt对象生命周期
```cpp
// 假设：父子对象关系导致析构冲突
// 测试：创建无父对象的STEPModelTreeWidget
STEPModelTreeWidget* widget = new STEPModelTreeWidget(nullptr);
```

### 优先级2: 事件循环简化
```cpp
// 假设：QMainWindow的复杂事件循环导致冲突
// 测试：使用简单QWidget替代QMainWindow
class SimpleWindow : public QWidget { /* 最简实现 */ };
```

### 优先级3: 内存访问模式
```cpp
// 假设：多组件环境下的内存访问冲突
// 测试：逐步添加组件，找到冲突源
```

## 📋 测试计划

### 阶段1: 最小化测试
1. **无父对象测试**: 移除STEPModelTreeWidget的父对象关系
2. **简单窗口测试**: 用QWidget替代QMainWindow
3. **直接创建测试**: 在main函数中直接创建组件

### 阶段2: 逐步复杂化
1. 从最简单的可工作版本开始
2. 逐步添加组件(菜单→工具栏→状态栏→停靠窗口)
3. 找到导致崩溃的具体组件

### 阶段3: 深度分析
1. 使用调试器分析崩溃堆栈
2. 内存泄漏检测
3. Qt对象树分析

## 🎯 预期突破点

### 最可能的原因
1. **Qt对象析构顺序冲突**: 主窗口析构时与STEP对象清理冲突
2. **事件循环干扰**: 复杂UI环境下的事件处理冲突
3. **内存管理差异**: 父子对象自动管理vs手动管理

### 验证方法
- 如果无父对象版本正常 → 确认是Qt对象生命周期问题
- 如果简单窗口版本正常 → 确认是QMainWindow复杂性问题
- 如果逐步添加组件能定位 → 确认是特定组件冲突

## 📝 技术债务

1. **临时禁用VTK可视化**: 需要在解决崩溃后重新集成
2. **简化的错误处理**: 当前异常处理还不够细粒度
3. **测试覆盖不足**: 需要更全面的自动化测试

---

**当前状态**: 🔍 深度调查中  
**下一步**: 实施最小化测试计划  
**目标**: 找到崩溃的根本原因并彻底解决