# STEP导入崩溃问题深度分析

## 🔍 排除法分析进展

### 已排除的假设
1. ❌ **VTK冲突假设** - 完全禁用VTK后仍然崩溃
2. ❌ **信号处理复杂性** - 简化信号处理后仍然崩溃
3. ❌ **STEP解析本身** - 独立测试程序完全正常

### 当前测试：极简主程序
- 禁用VTK组件
- 简化停靠窗口配置
- 移除构造函数定时器
- 只保留核心STEP模型树功能

## 🎯 剩余可能原因

### 1. QMainWindow vs QApplication差异
```cpp
// 独立测试程序
QApplication app(argc, argv);
STEPModelTreeWidget* treeWidget = new STEPModelTreeWidget();  // 无父对象

// 主程序
QMainWindow mainWindow;
STEPModelTreeWidget* treeWidget = new STEPModelTreeWidget(this);  // 父对象是MainWindow
```

### 2. 事件循环复杂性
- **独立程序**: 简单的`app.exec()`事件循环
- **主程序**: 复杂的主窗口事件循环，包含菜单、工具栏、状态栏等

### 3. 内存管理差异
- **独立程序**: 手动`delete treeWidget`
- **主程序**: Qt父子对象自动管理

### 4. 线程上下文差异
- **独立程序**: 纯净的线程环境
- **主程序**: 可能有其他组件的线程干扰

## 🧪 下一步测试方案

### 如果极简主程序仍然崩溃

#### 测试A: 移除父对象关系
```cpp
// 不使用this作为父对象
STEPModelTreeWidget* modelTreeWidget = new STEPModelTreeWidget(nullptr);
```

#### 测试B: 使用QWidget而不是QMainWindow
```cpp
// 创建简单的QWidget窗口而不是QMainWindow
class SimpleWindow : public QWidget {
    // 最简单的窗口实现
};
```

#### 测试C: 完全模拟独立程序环境
```cpp
// 在main函数中直接创建STEPModelTreeWidget
int main(int argc, char *argv[]) {
    QApplication app(argc, argv);
    STEPModelTreeWidget widget;
    widget.show();
    widget.loadSTEPFile("data/model/MPX3500.STEP");
    return app.exec();
}
```

### 如果极简主程序不崩溃

#### 逐步添加组件
1. 添加菜单栏
2. 添加工具栏
3. 添加状态栏
4. 添加其他停靠窗口
5. 找到导致崩溃的具体组件

## 🔧 深层技术分析

### Qt对象生命周期
```cpp
// 可能的问题：父子对象析构顺序
MainWindow::~MainWindow() {
    // Qt会自动析构子对象
    // 但STEPModelTreeWidget可能还在处理OpenCASCADE资源
    // 导致析构顺序冲突
}
```

### 事件循环干扰
```cpp
// 主程序的复杂事件循环可能与STEP加载的信号发送产生冲突
// 特别是在完成信号发送的时机
```

### 内存访问模式
- **独立程序**: 线性的内存访问模式
- **主程序**: 复杂的内存访问模式，多个组件同时访问

## 📊 崩溃时序分析

### 独立程序时序 (正常)
```
1. QApplication创建
2. STEPModelTreeWidget创建
3. STEP加载开始
4. 工作线程处理
5. 完成信号发送
6. 主线程处理 ✅
7. 程序继续运行
```

### 主程序时序 (崩溃)
```
1. QApplication创建
2. MainWindow创建 (复杂初始化)
3. STEPModelTreeWidget创建 (作为子对象)
4. STEP加载开始
5. 工作线程处理
6. 完成信号发送
7. 主线程处理 ❌ 崩溃点
```

## 🎯 关键假设

**主要假设**: 崩溃与Qt对象的父子关系和复杂的主窗口环境有关

**验证方法**: 
1. 测试极简主程序
2. 如果仍崩溃，测试无父对象版本
3. 如果不崩溃，逐步添加组件找到罪魁祸首

---

**状态**: 🧪 极简主程序测试中  
**下一步**: 根据测试结果决定进一步的分析方向