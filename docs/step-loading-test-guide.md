# STEP模型加载功能测试指南

## 测试目的

验证重构后的STEP模型加载功能是否正常工作。

## 测试环境

- 操作系统: Windows
- 编译器: Visual Studio 2022
- Qt版本: 6.10.1
- VTK版本: 9.2
- OpenCASCADE版本: 7.7.0

## 测试前准备

### 1. 编译项目

```bash
cd build
cmake --build . --config Debug
```

### 2. 准备测试文件

确保以下测试文件存在:
- `data/model/MPX3500.step` - 机械臂模型（约109个零件）
- `data/model/UR5.step` - UR5机械臂模型（如果有）

## 测试步骤

### 测试1: 基本加载功能

1. 启动程序 `build/Debug/SprayTrajectoryPlanning.exe`
2. 点击菜单 "文件" -> "导入STEP模型"
3. 选择 `data/model/MPX3500.step`
4. 观察：
   - ✅ 模型树面板自动显示并激活
   - ✅ 状态栏显示"正在加载STEP模型..."
   - ✅ 加载完成后显示"STEP模型加载成功"
   - ✅ 模型树显示完整的零件层级结构
   - ✅ 3D视图显示完整的机械臂模型

**预期结果**: 所有零件都正确显示，模型树结构清晰

### 测试2: 可见性控制

1. 在模型树中找到 "MPX3500 R-axis" 节点
2. 取消勾选该节点的复选框
3. 观察：
   - ✅ 3D视图中对应的零件消失
   - ✅ 系统日志显示 "组件 MPX3500 R-axis: 隐藏"
4. 重新勾选该节点
5. 观察：
   - ✅ 3D视图中对应的零件重新显示
   - ✅ 系统日志显示 "组件 MPX3500 R-axis: 显示"

**预期结果**: 可见性控制正常工作，无延迟

### 测试3: 多层级控制

1. 在模型树中找到 "MPX3500 BASE_L-Type" 节点（装配体）
2. 取消勾选该节点
3. 观察：
   - ✅ 该装配体下的所有子零件都消失
   - ✅ 子节点的复选框自动取消勾选
4. 重新勾选该节点
5. 观察：
   - ✅ 所有子零件重新显示
   - ✅ 子节点的复选框自动勾选

**预期结果**: 父子节点联动正常

### 测试4: 选择高亮

1. 在模型树中点击任意零件名称（不是复选框）
2. 观察：
   - ✅ 3D视图中对应的零件高亮显示（橙色）
   - ✅ 其他零件恢复默认颜色（浅灰色）
3. 点击另一个零件
4. 观察：
   - ✅ 新选中的零件高亮
   - ✅ 之前高亮的零件恢复默认颜色

**预期结果**: 选择高亮功能正常

### 测试5: 视图操作

1. 点击 "重置视图" 按钮
2. 观察：
   - ✅ 相机重置到默认位置
   - ✅ 模型完整可见
3. 使用鼠标拖拽旋转视图
4. 点击 "适应场景" 按钮
5. 观察：
   - ✅ 相机自动调整以显示完整模型

**预期结果**: 视图操作正常

### 测试6: 上下文菜单

1. 在模型树中右键点击任意节点
2. 观察：
   - ✅ 显示上下文菜单
   - ✅ 包含 "展开所有" 和 "折叠所有" 选项
3. 点击 "展开所有"
4. 观察：
   - ✅ 所有节点展开
5. 点击 "折叠所有"
6. 观察：
   - ✅ 所有节点折叠

**预期结果**: 上下文菜单功能正常

### 测试7: 重复加载

1. 再次点击 "导入STEP模型"
2. 选择同一个文件
3. 观察：
   - ✅ 旧的模型被清除
   - ✅ 新的模型正确加载
   - ✅ 没有内存泄漏或崩溃

**预期结果**: 重复加载正常

### 测试8: 加载不同模型

1. 点击 "导入STEP模型"
2. 选择另一个STEP文件（如UR5.step）
3. 观察：
   - ✅ 旧模型被清除
   - ✅ 新模型正确加载
   - ✅ 模型树更新为新模型的结构

**预期结果**: 切换模型正常

## 性能测试

### 加载时间测试

1. 记录加载MPX3500.step的时间
2. 预期时间: 10-30秒（取决于机器性能）
3. 如果超过1分钟，需要优化

### 内存使用测试

1. 使用任务管理器监控内存使用
2. 加载前记录内存
3. 加载后记录内存
4. 预期增加: 200-500MB（取决于模型大小）

### 渲染性能测试

1. 加载完成后旋转视图
2. 观察帧率是否流畅
3. 预期: 30fps以上

## 已知问题

### 问题1: UI阻塞
- **现象**: 加载大型STEP文件时UI会短暂冻结
- **原因**: 使用同步加载方式
- **影响**: 用户体验略差，但功能正常
- **解决方案**: 如需改进，可以使用QProgressDialog配合QTimer分步加载

### 问题2: 加载时间较长
- **现象**: 复杂模型加载需要10-30秒
- **原因**: OpenCASCADE的几何解析和网格化比较耗时
- **影响**: 需要等待
- **解决方案**: 已经是最优实现，无法进一步优化

## 故障排除

### 问题: 模型树显示但3D视图为空

**可能原因**:
1. Actor没有添加到渲染器
2. 相机位置不正确

**解决方法**:
1. 检查 `addActorsToRenderer` 是否被调用
2. 检查控制台日志中的Actor数量
3. 手动调用 `ResetCamera()`

### 问题: 可见性控制无效

**可能原因**:
1. 信号槽连接失败
2. Actor指针无效

**解决方法**:
1. 检查 `partVisibilityChanged` 信号是否连接
2. 检查控制台日志中的可见性变化消息
3. 验证Actor是否存在于actorMap中

### 问题: 程序崩溃

**可能原因**:
1. OpenCASCADE异常
2. VTK渲染异常
3. 内存访问错误

**解决方法**:
1. 查看控制台日志中的异常信息
2. 使用调试器定位崩溃位置
3. 检查STEP文件是否损坏

## 测试报告模板

```
测试日期: ____________________
测试人员: ____________________
测试环境: ____________________

测试结果:
[ ] 测试1: 基本加载功能 - 通过/失败
[ ] 测试2: 可见性控制 - 通过/失败
[ ] 测试3: 多层级控制 - 通过/失败
[ ] 测试4: 选择高亮 - 通过/失败
[ ] 测试5: 视图操作 - 通过/失败
[ ] 测试6: 上下文菜单 - 通过/失败
[ ] 测试7: 重复加载 - 通过/失败
[ ] 测试8: 加载不同模型 - 通过/失败

性能指标:
- 加载时间: ______ 秒
- 内存增加: ______ MB
- 渲染帧率: ______ fps

发现的问题:
1. ___________________________________
2. ___________________________________
3. ___________________________________

总体评价:
___________________________________
___________________________________
```

## 参考

- [STEP模型加载功能重构总结](./step-loading-refactoring-summary.md)
- [OpenCASCADE集成指南](./opencascade-integration-guide.md)
- [VTK集成指南](./vtk-integration-guide.md)
