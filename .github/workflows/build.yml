name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  check-code:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check project structure
      run: |
        echo "=== Project Structure Check ==="
        echo "Source files:"
        find src/ -name "*.cpp" -o -name "*.h" | wc -l
        echo "Documentation files:"
        find docs/ -name "*.md" | wc -l
        echo "Test scripts:"
        find tests/ -name "*.bat" | wc -l
        echo "Configuration files:"
        ls -la config/ || echo "No config directory"
        
    - name: Validate CMakeLists.txt
      run: |
        echo "=== CMake Configuration Check ==="
        if [ -f CMakeLists.txt ]; then
          echo "✓ CMakeLists.txt exists"
          echo "Project name:"
          grep "project(" CMakeLists.txt || echo "No project() found"
          echo "Required packages:"
          grep "find_package" CMakeLists.txt || echo "No find_package() found"
        else
          echo "✗ CMakeLists.txt missing"
          exit 1
        fi
        
    - name: Check dependencies configuration
      run: |
        echo "=== Dependencies Check ==="
        if [ -f vcpkg.json ]; then
          echo "✓ vcpkg.json exists"
          echo "Dependencies:"
          cat vcpkg.json
        else
          echo "✗ vcpkg.json missing"
        fi
        
  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate documentation
      run: |
        echo "=== Documentation Validation ==="
        if [ -f README.md ]; then
          echo "✓ README.md exists ($(wc -l < README.md) lines)"
        else
          echo "✗ README.md missing"
          exit 1
        fi
        
        if [ -f LICENSE ]; then
          echo "✓ LICENSE exists"
        else
          echo "✗ LICENSE missing"
        fi
        
        echo "Documentation files:"
        find docs/ -name "*.md" -type f | head -10
        
    - name: Check Chinese encoding
      run: |
        echo "=== Chinese File Encoding Check ==="
        echo "Files with Chinese characters:"
        find . -name "*.md" -o -name "*.cpp" -o -name "*.h" | xargs grep -l "[\u4e00-\u9fff]" | head -5 || echo "No Chinese files found"
        
  build-check:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.20'
        
    - name: CMake syntax check
      run: |
        echo "=== CMake Syntax Check ==="
        mkdir build-check
        cd build-check
        # Only check if CMake can parse the files, don't actually build
        cmake .. --help > nul 2>&1
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✓ CMake is available"
        } else {
          Write-Host "✗ CMake check failed"
          exit 1
        }
        
    - name: Project summary
      run: |
        echo "=== Project Summary ==="
        echo "Total files:"
        Get-ChildItem -Recurse -File | Measure-Object | Select-Object -ExpandProperty Count
        echo "Source files:"
        Get-ChildItem -Recurse -Include "*.cpp","*.h" | Measure-Object | Select-Object -ExpandProperty Count
        echo "Documentation files:"
        Get-ChildItem -Recurse -Include "*.md" | Measure-Object | Select-Object -ExpandProperty Count