cmake_minimum_required(VERSION 3.16)

project(SprayTrajectoryPlanning VERSION 1.0.0 LANGUAGES CXX)

# æ£€æŸ¥å¹¶ä½¿ç”¨é¡¹ç›®å†…çš„vcpkg
if(EXISTS "${CMAKE_SOURCE_DIR}/vcpkg/scripts/buildsystems/vcpkg.cmake")
    set(CMAKE_TOOLCHAIN_FILE "${CMAKE_SOURCE_DIR}/vcpkg/scripts/buildsystems/vcpkg.cmake" CACHE STRING "Vcpkg toolchain file")
    message(STATUS "ä½¿ç”¨é¡¹ç›®å†…çš„vcpkg: ${CMAKE_TOOLCHAIN_FILE}")
elseif(DEFINED ENV{VCPKG_ROOT})
    set(CMAKE_TOOLCHAIN_FILE "$ENV{VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" CACHE STRING "Vcpkg toolchain file")
    message(STATUS "ä½¿ç”¨ç¯å¢ƒå˜é‡çš„vcpkg: ${CMAKE_TOOLCHAIN_FILE}")
endif()

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# MSVCç‰¹å®šè®¾ç½®
if(MSVC)
    add_compile_options(/Zc:__cplusplus)
    add_compile_options(/permissive-)
    add_compile_options(/utf-8)
endif()

# ğŸ¯ åŠ è½½è·¯å¾„é…ç½®æ–‡ä»¶
include(${CMAKE_SOURCE_DIR}/config/paths.cmake)

# è®¾ç½®Qt6
find_package(Qt6 REQUIRED COMPONENTS Core Widgets Network Sql OpenGL OpenGLWidgets)

# ç¡®ä¿Qtåº“èƒ½è¢«æ‰¾åˆ°
if(NOT Qt6_FOUND)
    message(FATAL_ERROR "Qt6 not found!")
endif()

# å…ˆæ‰¾VTK
find_package(VTK REQUIRED COMPONENTS
    CommonCore
    CommonDataModel
    CommonExecutionModel
    RenderingCore
    RenderingOpenGL2
    InteractionStyle
    GUISupportQt
    IOGeometry
    IOPLY
    FiltersCore
    FiltersGeometry
    RenderingAnnotation
)

if(NOT VTK_FOUND)
    message(FATAL_ERROR "VTK not found! Please check VTK_DIR: ${VTK_DIR}")
endif()

message(STATUS "âœ… VTK found: ${VTK_VERSION}")
message(STATUS "VTK_DIR: ${VTK_DIR}")

# è®¾ç½®PCLï¼ˆç¦ç”¨PCLæŸ¥æ‰¾VTKï¼‰
set(PCL_ROOT "F:/PCL 1.13.0")
# ğŸ”§ å…³é”®ï¼šé˜»æ­¢PCLè¦†ç›–æˆ‘ä»¬çš„VTKè®¾ç½®
set(PCL_FIND_QUIETLY ON)
find_package(PCL 1.13 REQUIRED COMPONENTS common io filters features surface segmentation)

# æ‰‹åŠ¨è®¾ç½®PCLåŒ…å«ç›®å½•ï¼Œæ’é™¤VTKç›¸å…³
set(PCL_INCLUDE_DIRS_FILTERED)
foreach(dir ${PCL_INCLUDE_DIRS})
    if(NOT dir MATCHES "VTK" AND NOT dir MATCHES "vtk")
        list(APPEND PCL_INCLUDE_DIRS_FILTERED ${dir})
    endif()
endforeach()

include_directories(${PCL_INCLUDE_DIRS_FILTERED})
link_directories(${PCL_LIBRARY_DIRS})
add_definitions(${PCL_DEFINITIONS})

# è®¾ç½®è‡ªåŠ¨MOCã€UICã€RCC
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# åŒ…å«ç›®å½•
include_directories(${CMAKE_SOURCE_DIR}/src)

# æ·»åŠ å­ç›®å½•
add_subdirectory(src/UI)
add_subdirectory(src/Core)
add_subdirectory(src/Simulation)
add_subdirectory(src/Robot)
add_subdirectory(src/Data)

# ä¸»å¯æ‰§è¡Œæ–‡ä»¶
add_executable(SprayTrajectoryPlanning
    src/main.cpp
)

# æµ‹è¯•ç¨‹åºå·²ç§»åŠ¨åˆ° tests/programs/ ç›®å½•
# å¦‚éœ€ç¼–è¯‘æµ‹è¯•ç¨‹åºï¼Œè¯·å‚è€ƒ tests/programs/README.md

# é“¾æ¥Qtåº“ã€VTKåº“å’ŒPCLåº“
target_link_libraries(SprayTrajectoryPlanning
    Qt6::Core
    Qt6::Widgets
    Qt6::Network
    Qt6::Sql
    Qt6::OpenGL
    Qt6::OpenGLWidgets
    ${VTK_LIBRARIES}
    ${PCL_LIBRARIES}
    # OpenCASCADEæ ¸å¿ƒåº“ï¼ˆDebugç‰ˆæœ¬ï¼‰
    TKernel TKMath TKBRep TKGeomBase TKGeomAlgo TKTopAlgo TKPrim
    TKSTEP TKIGES TKMesh TKXSBase TKXCAF TKLCAF TKV3d
    UI
    Core
    Simulation
    Robot
    Data
)

# æµ‹è¯•ç¨‹åºé…ç½®å·²ç§»åŠ¨åˆ° tests/programs/CMakeLists.txt

# è®¾ç½®è¾“å‡ºç›®å½•
set_target_properties(SprayTrajectoryPlanning PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
)

# Windowsç‰¹å®šè®¾ç½®
if(WIN32)
    set_target_properties(SprayTrajectoryPlanning PROPERTIES
        WIN32_EXECUTABLE TRUE
    )
endif()

# æ·»åŠ æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
option(BUILD_TESTS "Build test programs" OFF)
if(BUILD_TESTS AND EXISTS "${CMAKE_SOURCE_DIR}/tests/CMakeLists.txt")
    add_subdirectory(tests)
endif()

# å®‰è£…è§„åˆ™
install(TARGETS SprayTrajectoryPlanning
    RUNTIME DESTINATION bin
)