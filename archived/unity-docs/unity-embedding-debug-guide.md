# Unity窗口嵌入调试指南

## 🎯 问题描述
Unity编辑器中可以看到点云，但Qt软件界面中看不到Unity窗口嵌入的内容。

## 🔧 调试步骤

### 1. 启动程序并检查状态

1. **启动Qt程序**：
   ```bash
   cd build/bin/Debug
   ./SprayTrajectoryPlanning.exe
   ```

2. **检查Unity项目设置**：
   - 确保Unity项目 `Unity/SpraySimulation` 已正确打开
   - 确保场景中有QtCommunication组件
   - 确保Unity处于播放模式（▶️按钮已按下）

### 2. 使用增强的窗口检测功能

**新增功能**：
- 更智能的Unity窗口检测
- 详细的调试日志输出
- 手动嵌入测试按钮

**操作步骤**：
1. 在Qt程序中点击 **"手动嵌入Unity"** 按钮
2. 观察控制台输出的详细日志
3. 查看窗口检测和嵌入过程

### 3. 分析调试日志

**正常的日志输出应该包括**：
```
🔍 使用枚举方式查找Unity窗口...
🎯 发现Unity相关窗口: SpraySimulation - Unity 类名: UnityWndClass
✅ 找到SpraySimulation项目窗口!
🎯 最终选择的Unity窗口:
   标题: SpraySimulation - Unity
   类名: UnityWndClass
   句柄: 0x12345678
   可见: true
🔧 开始嵌入Unity窗口...
✅ 成功设置父窗口
✅ 成功修改窗口样式
✅ 成功设置窗口位置和大小
🎉 Unity窗口嵌入完成!
```

### 4. 常见问题排查

#### 问题A：找不到Unity窗口
**日志显示**：`❌ 未找到Unity窗口`

**解决方法**：
1. 确保Unity编辑器正在运行
2. 确保Unity项目已加载并处于播放模式
3. 检查Unity窗口标题是否包含"SpraySimulation"
4. 尝试重新启动Unity项目

#### 问题B：找到窗口但嵌入失败
**日志显示**：找到窗口但后续嵌入步骤失败

**解决方法**：
1. 检查Windows权限设置
2. 确保Qt程序以管理员权限运行
3. 检查Unity窗口是否被其他程序占用

#### 问题C：嵌入成功但看不到内容
**日志显示**：嵌入完成但Qt界面仍显示占位符

**解决方法**：
1. 检查Unity窗口是否真的在播放模式
2. 确保Unity场景中有可见的内容
3. 尝试在Unity中手动调整相机视角

### 5. 手动验证步骤

#### 步骤1：验证Unity连接
1. 在Unity Console中查看连接日志：
   ```
   Unity Qt通信模块启动
   尝试连接到Qt应用程序 localhost:12346
   ✅ 成功连接到Qt应用程序
   ```

2. 在Qt程序中查看状态：
   - 状态标签应显示"Unity已连接 ✓"
   - 绿色背景表示连接成功

#### 步骤2：测试点云加载
1. 在Qt程序中导入点云文件
2. 观察Unity Console输出：
   ```
   🔧 处理工件数据...
   📊 接收到有效点云数据: sample_cube, 点数: 8000
   🔵 开始创建优化点云，点数: 8000
   ✅ 点云加载完成: sample_cube
   ```

#### 步骤3：验证窗口嵌入
1. 点击"手动嵌入Unity"按钮
2. 观察占位标签是否消失
3. 检查是否能在Qt界面中看到Unity内容

### 6. 高级调试技巧

#### 使用Windows任务管理器
1. 打开任务管理器
2. 查看Unity.exe进程
3. 确认进程正在运行且消耗GPU资源

#### 使用Spy++工具（如果可用）
1. 启动Spy++
2. 查找Unity相关窗口
3. 检查窗口层次结构和属性

#### 检查Unity项目设置
1. 确保Unity项目构建设置正确
2. 检查Display Resolution Dialog设置
3. 验证Fullscreen Mode设置为Windowed

### 7. 备用解决方案

#### 方案A：重新设置Unity项目
1. 关闭Unity编辑器
2. 删除Unity项目的Library文件夹
3. 重新打开Unity项目
4. 重新设置QtCommunication组件

#### 方案B：使用Unity构建版本
1. 在Unity中构建独立应用程序
2. 修改Qt代码启动构建的exe文件
3. 嵌入构建版本的Unity窗口

#### 方案C：调整窗口嵌入策略
1. 尝试不同的窗口样式设置
2. 使用不同的SetWindowPos参数
3. 调整窗口层级和可见性

## 📊 成功指标

当Unity窗口嵌入成功时，你应该看到：

1. **Qt界面变化**：
   - 占位标签消失
   - 3D视图区域显示Unity内容
   - 状态显示"Unity窗口已嵌入 ✓"

2. **Unity内容可见**：
   - 可以看到Unity场景内容
   - 点云数据正确显示
   - 鼠标可以在嵌入区域操作

3. **交互功能正常**：
   - 鼠标旋转、缩放功能正常
   - 窗口大小调整时Unity窗口同步
   - 点云加载和显示功能正常

## 🆘 如果仍然无法解决

请提供以下信息：
1. 控制台完整日志输出
2. Unity Console的连接日志
3. Windows版本和Unity版本信息
4. 是否以管理员权限运行程序

---

**记住**：Unity窗口嵌入是一个复杂的系统级操作，可能受到多种因素影响。通过详细的日志分析，我们可以准确定位问题所在。