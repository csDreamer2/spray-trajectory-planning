# Unity窗口嵌入测试指南

## 🎯 测试目标
验证Unity 3D窗口能够成功嵌入到Qt应用程序界面中，实现统一的用户体验。

## 🚀 测试步骤

### 1. 启动Qt应用程序
```bash
cd build/bin/Debug
./SprayTrajectoryPlanning.exe
```

### 2. 设置Unity项目（首次运行必须）
**重要：Unity脚本已恢复，需要在Unity中正确设置场景**

1. 打开Unity Hub
2. 添加项目：`Unity/SpraySimulation`
3. 打开项目，等待完全加载
4. 打开主场景：`Assets/Scenes/SampleScene.unity`
5. 设置Qt通信组件：
   - 创建空GameObject，命名为"QtCommunication"
   - 添加QtCommunication脚本组件
   - 设置连接参数：Host=localhost, Port=12346
6. 保存场景

### 3. 初始化Unity（两种方式）

**方式A：Qt自动启动（推荐）**
- 点击"启动Unity应用程序"按钮
- 观察状态变化：
  - "正在初始化..." → "Unity编辑器已启动"
  - 状态标签显示"正在尝试嵌入Unity窗口..."

**方式B：手动启动**
- 手动打开Unity项目
- 点击▶️播放按钮运行场景
- Qt会自动检测Unity窗口

### 4. 运行Unity场景
- 等待Unity编辑器完全加载
- 在Unity编辑器中点击▶️播放按钮
- 观察Unity Console显示连接日志：
  ```
  Unity Qt通信模块启动
  尝试连接到Qt应用程序 localhost:12346
  ✅ 成功连接到Qt应用程序
  ```

### 5. 验证窗口嵌入
**预期结果**：
- Unity窗口自动嵌入到Qt界面的3D视图区域
- 占位标签自动隐藏
- 按钮文本变为"Unity已嵌入"
- 可以在Qt界面中直接操作Unity场景
- 状态显示"Unity已连接 ✓"

### 6. 测试点云加载
- 在Qt程序中点击"导入点云"
- 选择测试文件：`test_data/sample_cube.ply`
- 观察Unity中显示3D点云
- 验证相机自动聚焦到点云

## 📋 测试检查点

### ✅ 基本功能测试

#### 1. Unity进程启动
- [ ] Unity编辑器成功启动
- [ ] 控制台显示Unity启动日志
- [ ] 进程ID正确记录

#### 2. 窗口查找
- [ ] 定时器每秒查找Unity窗口
- [ ] 控制台显示窗口查找日志
- [ ] 成功找到Unity窗口句柄

#### 3. 窗口嵌入
- [ ] Unity窗口嵌入到Qt界面
- [ ] 占位标签正确隐藏
- [ ] 窗口大小匹配Qt区域
- [ ] 窗口边框和标题栏被移除

#### 4. 交互功能
- [ ] 鼠标操作正常转发到Unity
- [ ] 键盘输入正常工作
- [ ] Unity场景响应用户操作
- [ ] 相机控制功能正常

### ✅ 高级功能测试

#### 5. 窗口大小调整
- [ ] 调整Qt窗口大小时Unity窗口同步调整
- [ ] 最大化/最小化窗口正常工作
- [ ] 窗口比例保持正确

#### 6. 连接状态管理
- [ ] Unity连接成功后状态正确显示
- [ ] 点云加载功能正常工作
- [ ] TCP通信正常建立

#### 7. 错误处理
- [ ] Unity进程异常退出时正确处理
- [ ] 窗口查找失败时显示合适提示
- [ ] 嵌入失败时回退到原始状态

## 🔍 调试信息

### 控制台日志示例

**成功嵌入的日志**：
```
Unity进程已启动，开始尝试嵌入窗口
未找到Unity窗口，继续搜索...
未找到Unity窗口，继续搜索...
通过标题找到Unity窗口: Unity
找到Unity窗口，开始嵌入
Unity窗口嵌入完成，位置: QRect(10,35 800x600)
Unity窗口嵌入成功
```

**窗口查找失败的日志**：
```
Unity进程已启动，开始尝试嵌入窗口
未找到Unity窗口，继续搜索...
未找到Unity窗口，继续搜索...
(持续重复...)
```

### 常见问题排查

#### 问题1：找不到Unity窗口
**症状**：定时器一直运行，控制台显示"未找到Unity窗口"

**排查步骤**：
1. 确认Unity编辑器已启动
2. 确认Unity项目已加载
3. 确认Unity场景正在运行（播放模式）
4. 检查Unity窗口标题是否匹配预期

**解决方法**：
- 手动检查Unity窗口标题
- 尝试不同的窗口查找策略
- 确保Unity进程ID匹配

#### 问题2：窗口嵌入后显示异常
**症状**：Unity窗口嵌入但显示不正确

**排查步骤**：
1. 检查窗口大小和位置参数
2. 验证窗口样式设置
3. 确认Z-order正确

**解决方法**：
- 调整SetWindowPos参数
- 检查窗口样式标志
- 验证父子窗口关系

#### 问题3：鼠标键盘无法操作
**症状**：Unity窗口显示但无法交互

**排查步骤**：
1. 检查窗口焦点状态
2. 验证事件转发机制
3. 确认窗口层级关系

**解决方法**：
- 设置正确的窗口焦点
- 实现事件转发
- 调整窗口Z-order

## 📊 性能测试

### 渲染性能
- **目标FPS**: 60 FPS
- **内存使用**: < 500MB
- **CPU使用率**: < 30%

### 响应性测试
- **窗口嵌入时间**: < 5秒
- **大小调整延迟**: < 100ms
- **鼠标响应时间**: < 16ms

## 🎯 验收标准

### 必须通过的测试
- [x] Unity窗口成功嵌入Qt界面
- [x] 鼠标和键盘交互正常
- [x] 窗口大小调整同步
- [x] 点云加载和显示正常
- [x] 连接状态正确显示

### 可选的高级功能
- [ ] 多Unity实例支持
- [ ] 窗口状态保存恢复
- [ ] 自定义窗口布局

## 📈 测试报告模板

```
Unity窗口嵌入测试报告
===================

测试日期: ____
测试环境: Windows 10/11, Qt 6.x, Unity 2022.3+

基本功能测试:
□ Unity进程启动: 通过/失败
□ 窗口查找: 通过/失败  
□ 窗口嵌入: 通过/失败
□ 交互功能: 通过/失败

高级功能测试:
□ 窗口大小调整: 通过/失败
□ 连接状态管理: 通过/失败
□ 错误处理: 通过/失败

性能测试:
□ 渲染性能: ___FPS
□ 内存使用: ___MB
□ CPU使用率: ___%

问题记录:
1. ________________
2. ________________
3. ________________

总体评价: 通过/失败
建议: ________________
```

---
**测试版本**: v1.0.0  
**最后更新**: 2024-12-18  
**状态**: 待测试